name: Deploy to Production

on:
  release:
    types: [published]

permissions:
  contents: read
  packages: read

jobs:
  deploy:
    name: Deploy Auth Backend
    runs-on: self-hosted
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Deploy to production
        run: |
          cd /home/ubuntu

          # Create .env file from secrets
          cat > .env <<'EOF'
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          KEYCLOAK_BASE_URL=${{ secrets.KEYCLOAK_BASE_URL }}
          KEYCLOAK_ISSUER_PREFIX=${{ secrets.KEYCLOAK_ISSUER_PREFIX }}
          KEYCLOAK_SAAS_ISSUER_URI=${{ secrets.KEYCLOAK_SAAS_ISSUER_URI }}
          KEYCLOAK_ADMIN_CLIENT_ID=${{ secrets.KEYCLOAK_ADMIN_CLIENT_ID }}
          KEYCLOAK_ADMIN_CLIENT_SECRET=${{ secrets.KEYCLOAK_ADMIN_CLIENT_SECRET }}
          SAAS_ADMIN_CLIENT_SECRET=${{ secrets.SAAS_ADMIN_CLIENT_SECRET }}
          SPRING_PROFILES_ACTIVE=${{ secrets.SPRING_PROFILES_ACTIVE }}
          OTEL_SDK_DISABLED=true
          EOF

          # Login to GHCR with token that has packages:read
          echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

          # Pull latest images
          docker compose pull auth-backend

          # Restart with new image (force recreate)
          docker compose up -d --force-recreate auth-backend

          # Clean up old images
          docker image prune -f

          # Show status
          echo "=== Deployment Status ==="
          docker compose ps
          echo ""
          echo "=== Recent Logs ==="
          docker logs auth-backend --tail 30
