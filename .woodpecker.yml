# Pipeline 1: Build on Push
kind: pipeline
name: keycloak-spi

steps:
  - name: build
    image: eclipse-temurin:21-jdk
    commands:
      - ./gradlew :keycloak-spi:shadowJar --no-daemon
      - mkdir -p /shared/providers
      - cp keycloak-spi/build/libs/keycloak-user-storage-spi-*.jar /shared/providers/keycloak-user-storage-spi.jar
    volumes:
      - name: providers
        path: /shared/providers

# Woodpecker triggers are slightly more structured
when:
  - event: [push, manual] # 'manual' replaces Drone's 'custom'
    branch: [master, main]
    path:
      include:
        - 'keycloak-spi/**'
        - '.woodpecker.yml'

volumes:
  - name: providers
    host:
      path: /opt/keycloak-providers

---
# Pipeline 2: Release on Tag
kind: pipeline
name: keycloak-spi-release

steps:
  - name: build
    image: eclipse-temurin:21-jdk
    commands:
      # Use CI_COMMIT_TAG instead of DRONE_TAG
      - export VERSION=${CI_COMMIT_TAG#v}
      - ./gradlew :keycloak-spi:shadowJar -Pversion=$VERSION --no-daemon
      - mkdir -p /shared/providers
      - cp keycloak-spi/build/libs/keycloak-user-storage-spi-*.jar /shared/providers/keycloak-user-storage-spi.jar
    volumes:
      - name: providers
        path: /shared/providers

when:
  - event: tag
    # ref: refs/tags/v* is usually redundant if event is 'tag',
    # but you can add a tag filter if needed:
    tag: v* volumes:
  - name: providers
    host:
      path: /opt/keycloak-providers