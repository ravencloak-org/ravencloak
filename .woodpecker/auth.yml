# Auth Backend - Build & Test (Push/PR/Manual)
when:
  - event: [push, pull_request, manual]
    path:
      include:
        - "src/**"
        - "build.gradle.kts"
        - "settings.gradle.kts"
        - ".woodpecker/auth*.yml"
      exclude:
        - "keycloak-spi/**"

steps:
  - name: build
    image: eclipse-temurin:21-jdk
    environment:
      GRADLE_USER_HOME: /root/.gradle
      CI: "true"
      S3_BUILD_CACHE_BUCKET:
        from_secret: s3_build_cache_bucket
      S3_BUILD_CACHE_REGION:
        from_secret: s3_build_cache_region
      S3_BUILD_CACHE_ACCESS_KEY_ID:
        from_secret: s3_build_cache_access_key_id
      S3_BUILD_CACHE_SECRET_KEY:
        from_secret: s3_build_cache_secret_key
      S3_BUILD_CACHE_ENDPOINT:
        from_secret: s3_build_cache_endpoint
    commands:
      - echo "Building Auth Backend..."
      - ./gradlew compileKotlin bootJar --no-daemon -x :keycloak-spi:compileKotlin -x test
      - echo "Build successful!"
    volumes:
      - /opt/woodpecker-cache/gradle:/root/.gradle
