# Combined Release (Tag: release-v* or Manual)
# Trigger: woodpecker-cli pipeline create dsjkeeplearning/kos-auth-backend --branch main --var DEPLOY_TO=release-all
when:
  - event: tag
    ref: refs/tags/release-v*
  - event: manual
    evaluate: 'CI_PIPELINE_DEPLOY_TO == "release-all"'

steps:
  - name: determine-version
    image: alpine/git
    environment:
      GITHUB_TOKEN:
        from_secret: github_token
    commands:
      - |
        if [ "$CI_PIPELINE_EVENT" = "manual" ]; then
          # Auto-increment: find latest release-v* tag and bump patch version
          LATEST_TAG=$(git tag -l 'release-v*' --sort=-v:refname | head -n1)
          if [ -z "$LATEST_TAG" ]; then
            NEW_VERSION="release-v1.0.0"
          else
            # Extract version numbers
            VERSION=${LATEST_TAG#release-v}
            MAJOR=$(echo $VERSION | cut -d. -f1)
            MINOR=$(echo $VERSION | cut -d. -f2)
            PATCH=$(echo $VERSION | cut -d. -f3)
            # Increment patch
            PATCH=$((PATCH + 1))
            NEW_VERSION="release-v$MAJOR.$MINOR.$PATCH"
          fi
          echo "Auto-incrementing to $NEW_VERSION"

          # Create and push tag
          git config --global user.email "ci@keeplearningos.com"
          git config --global user.name "Woodpecker CI"
          git remote set-url origin https://x-access-token:$GITHUB_TOKEN@github.com/${CI_REPO}.git
          git tag $NEW_VERSION
          git push origin $NEW_VERSION

          echo $NEW_VERSION > .version
        else
          echo $CI_COMMIT_TAG > .version
        fi
        echo "Version: $(cat .version)"

  - name: build-and-push
    image: amazoncorretto:21
    volumes:
      - /var/lib/woodpecker/cache/gradle:/root/.gradle
    environment:
      CI: "true"
      GRADLE_OPTS: "-Xmx128m"
      GITHUB_TOKEN:
        from_secret: github_token
      S3_BUILD_CACHE_BUCKET:
        from_secret: s3_build_cache_bucket
      S3_BUILD_CACHE_REGION:
        from_secret: s3_build_cache_region
      AWS_ACCESS_KEY_ID:
        from_secret: s3_build_cache_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: s3_build_cache_secret_key
      S3_BUILD_CACHE_ENDPOINT:
        from_secret: s3_build_cache_endpoint
    commands:
      - rm -rf /root/.gradle/daemon 2>/dev/null || true
      - find /root/.gradle -name "*.lock" -type f -delete 2>/dev/null || true
      - |
        if [ -n "$CI_COMMIT_TAG" ]; then
          VERSION=${CI_COMMIT_TAG#release-v}
        else
          VERSION=$(cat .version 2>/dev/null)
          VERSION=${VERSION#release-v}
        fi
        echo "Building all modules version $VERSION"
        test -n "$VERSION" || { echo "ERROR - VERSION is empty (CI_COMMIT_TAG=$CI_COMMIT_TAG)"; exit 1; }
        ./gradlew clean :keycloak-spi:shadowJar :bootJar :jib :scim-common:publish :forge:publish :keycloak-spi:publish --no-daemon -x test -Pversion=$VERSION -PjibTag=$VERSION -Djib.to.auth.username=dsjkeeplearning -Djib.to.auth.password=$GITHUB_TOKEN
        mkdir -p release-assets
        cp keycloak-spi/build/libs/*.jar release-assets/
        cp build/libs/*.jar release-assets/

  - name: generate-changelog
    image: alpine/git
    commands:
      - |
        VERSION=${CI_COMMIT_TAG:-$(cat .version 2>/dev/null)}
        PREV_TAG=$(git tag -l 'release-v*' --sort=-v:refname | grep -v $VERSION | head -n1)
        if [ -z "$PREV_TAG" ]; then
          PREV_TAG=$(git rev-list --max-parents=0 HEAD)
        fi
        echo "Generating changelog from $PREV_TAG to $VERSION"

        echo "# Changelog for $VERSION" > release-assets/CHANGELOG.md
        echo "" >> release-assets/CHANGELOG.md

        echo "## Auth Backend Changes" >> release-assets/CHANGELOG.md
        git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" -- src/ build.gradle.kts >> release-assets/CHANGELOG.md || echo "- No changes" >> release-assets/CHANGELOG.md
        echo "" >> release-assets/CHANGELOG.md
        echo "" >> release-assets/CHANGELOG.md

        echo "## Keycloak SPI Changes" >> release-assets/CHANGELOG.md
        git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" -- keycloak-spi/ >> release-assets/CHANGELOG.md || echo "- No changes" >> release-assets/CHANGELOG.md
        echo "" >> release-assets/CHANGELOG.md
        echo "" >> release-assets/CHANGELOG.md

        echo "## Other Changes" >> release-assets/CHANGELOG.md
        git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" -- . ':!keycloak-spi/' ':!src/' >> release-assets/CHANGELOG.md || echo "- No changes" >> release-assets/CHANGELOG.md
        echo "" >> release-assets/CHANGELOG.md

        cat release-assets/CHANGELOG.md

  - name: deploy-spi
    image: docker:cli
    volumes:
      - /opt/keycloak-providers:/shared/providers
      - /var/run/docker.sock:/var/run/docker.sock
    commands:
      - mkdir -p /shared/providers
      - rm -f /shared/providers/*.jar
      - echo "Files in release-assets:" && ls -la release-assets/
      - SPI_JAR=$(ls release-assets/keycloak-user-storage-spi*.jar 2>/dev/null | head -1) && cp "$SPI_JAR" /shared/providers/keycloak-user-storage-spi.jar
      - echo "Deployed SPI to /opt/keycloak-providers/"
      - echo "Restarting Keycloak to load new SPI..."
      - 'docker restart keycloak || echo "Warning - Could not restart keycloak container"'

  - name: update-readme
    image: alpine/git
    environment:
      GITHUB_TOKEN:
        from_secret: github_token
    commands:
      - |
        VERSION=${CI_COMMIT_TAG:-$(cat .version 2>/dev/null)}
        SEMVER=$(echo ${VERSION} | sed 's/^release-//')
        git config --global user.email "ci@keeplearningos.com"
        git config --global user.name "Woodpecker CI"
        git remote set-url origin https://x-access-token:$GITHUB_TOKEN@github.com/${CI_REPO}.git
        git fetch origin main
        git checkout main
        sed -i "s|auth-v[0-9.]*-blue|auth-${SEMVER}-blue|g" README.md
        sed -i "s|keycloak--spi-v[0-9.]*-green|keycloak--spi-${SEMVER}-green|g" README.md
        git add README.md
        git diff --cached --quiet || git commit -m "Update version badges to ${VERSION}"
        git push origin main

  - name: github-release
    image: alpine
    environment:
      GITHUB_TOKEN:
        from_secret: github_token
    commands:
      - apk add --no-cache github-cli
      - |
        VERSION=${CI_COMMIT_TAG:-$(cat .version 2>/dev/null)}
        if gh release view $VERSION --repo $CI_REPO > /dev/null 2>&1; then
          echo "Release $VERSION already exists, updating notes and uploading assets..."
          gh release edit $VERSION --repo $CI_REPO --notes-file release-assets/CHANGELOG.md
          gh release upload $VERSION --repo $CI_REPO --clobber release-assets/*.jar
        else
          gh release create $VERSION \
            --repo $CI_REPO \
            --title "Release $VERSION" \
            --notes-file release-assets/CHANGELOG.md \
            release-assets/*.jar
        fi

  - name: deploy
    image: docker:cli
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      GITHUB_TOKEN:
        from_secret: github_token
      KEYCLOAK_ISSUER_PREFIX:
        from_secret: keycloak_issuer_prefix
      KEYCLOAK_SAAS_ISSUER_URI:
        from_secret: keycloak_saas_issuer_uri
      SAAS_ADMIN_CLIENT_SECRET:
        from_secret: saas_admin_client_secret
      DB_HOST:
        from_secret: db_host
      DB_PORT:
        from_secret: db_port
      DB_NAME:
        from_secret: db_name
      DB_USERNAME:
        from_secret: db_username
      DB_PASSWORD:
        from_secret: db_password
      SPRING_PROFILES_ACTIVE:
        from_secret: spring_profiles_active
    commands:
      - echo $GITHUB_TOKEN | docker login ghcr.io -u dsjkeeplearning --password-stdin
      - 'docker pull "ghcr.io/dsjkeeplearning/kos-auth-backend:${CI_COMMIT_TAG#release-v}"'
      - docker stop auth-backend || true
      - docker rm auth-backend || true
      - 'echo "Deploying auth-backend version ${CI_COMMIT_TAG#release-v}"'
      - 'docker run -d --name auth-backend --restart unless-stopped -p 8080:8080 -e KEYCLOAK_ISSUER_PREFIX="$KEYCLOAK_ISSUER_PREFIX" -e KEYCLOAK_SAAS_ISSUER_URI="$KEYCLOAK_SAAS_ISSUER_URI" -e SAAS_ADMIN_CLIENT_SECRET="$SAAS_ADMIN_CLIENT_SECRET" -e DB_HOST="$DB_HOST" -e DB_PORT="$DB_PORT" -e DB_NAME="$DB_NAME" -e DB_USERNAME="$DB_USERNAME" -e DB_PASSWORD="$DB_PASSWORD" -e SPRING_PROFILES_ACTIVE="$SPRING_PROFILES_ACTIVE" "ghcr.io/dsjkeeplearning/kos-auth-backend:${CI_COMMIT_TAG#release-v}"'
      - docker image prune -f
